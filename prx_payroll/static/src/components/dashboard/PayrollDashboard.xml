<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
  <t t-name="prx_payroll.PayrollDashboard" owl="1">
    <style>
      .dashboard-layout {
        display: flex;
        flex-direction: row;
        height: 100%;
      }

      .dashboard-main {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
      }

    .dashboard-sidebar {
      width: 400px;
      min-width: 300px;
      max-width: 100%;
      border-left: 1px solid #dee2e6;
      padding: 1rem;
      background-color: #f8f9fa;
      overflow-y: auto;
      transition: all 0.3s ease;
    }

    @media (max-width: 992px) {
      .dashboard-layout {
        flex-direction: column;
      }

      .dashboard-sidebar {
        width: 100%;
        border-left: none;
        border-top: 1px solid #dee2e6;
        padding: 0.75rem;
      }
    }
    .dashboard-container {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      min-height: 100%;
    }

      .kpi-box-group, .charts-wrapper {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        justify-content: space-between;
      }

      .kpi-box {
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem 2rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        flex: 1 1 300px;
        transition: all 0.5s ease-in-out;
      }

      .chart-card {
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem 2rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        flex: 1 1 500px;
        min-width: 500px;
        transition: all 0.5s ease-in-out;
      }

      .kpi-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.25rem;
        margin-bottom: 0.25rem;
        font-size: 0.95rem;
        padding: 2px 0;
      }

      .kpi-label { color: #6c757d; }
      .kpi-value { color: #212529; }

      .kpi-title {
        font-size: 0.95rem;
        font-weight: bold;
        color: #6c757d;
      }

      .kpi-up { color: green; font-size: 1.4rem; font-weight: bold; }
      .kpi-down { color: red; font-size: 1.4rem; font-weight: bold; }

      .payroll-header {
        position: relative;
        text-align: center;
      }

      .payroll-header .period-label {
        position: absolute;
        right: 0;
        top: 0;
      }
      .payroll-header .btn {
        z-index: 1;
      }

      .kpi-period {
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--bs-primary);
      }

      @media (max-width: 768px) {
        .kpi-box-group, .charts-wrapper {
          flex-direction: column;
        }
      }

      .kpi-box:hover {
        background-color: azure;
        transform: scale(1.03);
      }

      .kpi-row.clickable {
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.3s ease;
        border-radius: 6px;
      }

      .kpi-row.clickable:hover {
        background-color: #f0f8ff;
        transform: scale(1.02);
      }

      .kpi-title.link-like {
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
      }

      .kpi-title.link-like:hover {
        text-decoration: underline;
        color: blue;
      }

      .chart-card:hover {
        background-color: #f8f9fa;
        transform: scale(1.02);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        z-index: 1;
      }

      .chart-card:hover {
        cursor: pointer;
      }
      .dashboard-sidebar.collapsed {
        width: 30px !important;
        min-width: 30px !important;
        overflow: hidden;
        padding: 0.5rem 0.25rem !important;
      }

      .note-scroll-wrapper {
        max-height: calc(100vh - 200px);
        overflow-y: auto;
        padding-right: 4px;
      }

      .collapsed-note {
        width: 40px !important;
        overflow: hidden;
        padding: 0.25rem !important;
        transition: width 0.3s ease;
      }

    </style>

    <div class="dashboard-layout">

      <!-- მარცხენა ნაწილი -->
      <div class="dashboard-main">
        <div class="dashboard-container">

          <!-- KPI ბლოკები -->
          <div class="kpi-box-group">
          <t t-if="state.isPayrollAdmin">
            <div class="kpi-box" style="max-height: 190px;">
              <div class="payroll-header mb-3">
                <h6 class="kpi-title mb-2 d-inline-block link-like fa-external-link" t-on-click="openPayrollTransactions">
                  Payroll
                </h6>
                <span class="period-label text-primary small">
                  <t t-esc="payrollMonth.value"/>
                </span>
              </div>
              <div class="kpi-row">
                <div class="kpi-label">თანხა</div>
                <div class="kpi-value"><t t-esc="payrollTotalAmount.value.toFixed(2)"/></div>
              </div>
              <div class="kpi-row">
                <div class="kpi-label">თანამშრომელი</div>
                <div class="kpi-value"><t t-esc="payrollEmployeeCount.value"/></div>
              </div>
              <div class="kpi-row">
                <div class="kpi-label">AVG</div>
                <div class="kpi-value"><t t-esc="payrollAverageAmount.value.toFixed(2)"/></div>
              </div>
            </div>

            <div class="kpi-box text-center" style="max-height: 190px;">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="kpi-title">MoM Growth</div>
                <div class="kpi-period">
                  <t t-esc="momPeriodStart.value"/> → <t t-esc="momPeriodEnd.value"/>
                </div>
              </div>
              <div class="d-flex align-items-end justify-content-center" style="min-height: 50px;">
                <t t-if="compareAmountLastTwoPeriod.value &gt; 0">
                  <span class="text-success fw-bold fs-5">
                    ▲ <t t-esc="compareAmountLastTwoPeriod.value.toFixed(2)"/>%
                  </span>
                </t>
                <t t-elif="compareAmountLastTwoPeriod.value &lt; 0">
                  <t t-set="abs_value" t-value="(-1 * compareAmountLastTwoPeriod.value).toFixed(2)"/>
                  <span class="text-danger fw-bold fs-5">
                    ▼ <t t-esc="abs_value"/>%
                  </span>
                </t>
                <t t-else="">
                  <span class="text-muted fw-bold fs-5">0.00%</span>
                </t>
              </div>
            </div>

            <div class="kpi-box text-center" style="max-height: 190px;">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="kpi-title">YoY Growth</div>
                <div class="kpi-period">
                  <t t-esc="yoyPeriodStart.value"/> → <t t-esc="yoyPeriodEnd.value"/>
                </div>
              </div>
              <div class="d-flex align-items-end justify-content-center" style="min-height: 50px;">
                <t t-if="compareAmountLastYearCurrentMonth.value &gt; 0">
                  <span class="text-success fw-bold fs-5">
                    ▲ <t t-esc="compareAmountLastYearCurrentMonth.value.toFixed(2)"/>%
                  </span>
                </t>
                <t t-elif="compareAmountLastYearCurrentMonth.value &lt; 0">
                  <t t-set="abs_value" t-value="(-1 * compareAmountLastYearCurrentMonth.value).toFixed(2)"/>
                  <span class="text-danger fw-bold fs-5">
                    ▼ <t t-esc="abs_value"/>%
                  </span>
                </t>
                <t t-else="">
                  <span class="text-muted fw-bold fs-5">0.00%</span>
                </t>
              </div>
            </div>
          </t>

            <div class="kpi-box text-center" style="max-height: 190px;">
              <div class="payroll-header mb-3">
                <h6 class="kpi-title mb-2">Tabel</h6>
                <span class="period-label text-primary small">
                  <t t-esc="tabelMonth.value"/>
                </span>
              </div>
              <div class="kpi-row clickable" t-att-data-status="'open'" t-on-click="onClickStatusFromElement">
                <div class="kpi-label">ღია</div>
                <div class="kpi-value"><t t-esc="totalTabelOpen.value"/></div>
              </div>
              <div class="kpi-row clickable" t-att-data-status="'closed'" t-on-click="onClickStatusFromElement">
                <div class="kpi-label">დახურული</div>
                <div class="kpi-value"><t t-esc="totalTabelClosed.value"/></div>
              </div>
              <div class="kpi-row clickable" t-att-data-status="'posted'" t-on-click="onClickStatusFromElement">
                <div class="kpi-label">დაპოსტილი</div>
                <div class="kpi-value"><t t-esc="totalTabelPosted.value"/></div>
              </div>
              <div class="kpi-row clickable" t-att-data-status="'cancelled'" t-on-click="onClickStatusFromElement">
                <div class="kpi-label">გაუქმებული</div>
                <div class="kpi-value"><t t-esc="totalTabelCanceled.value"/></div>
              </div>
            </div>
          </div>
      <t t-if="state.isPayrollAdmin">
          <!-- Charts -->
          <div class="charts-wrapper">

          <div class="chart-card">
            <PRXPayrollDashboardActionBox/>
          </div>

            <div class="chart-card">
              <h5 class="fw-bold mb-3">Last 3 Month</h5>
              <ul class="list-unstyled px-1 small">
                <li><a href="#" class="text-primary">გადასახადი</a><span class="float-end"><t t-esc="tax.value.toFixed(2)"/></span></li>
                <li><a href="#" class="text-primary">დაქვითვა</a><span class="float-end"><t t-esc="deduction.value.toFixed(2)"/></span></li>
                <li><a href="#" class="text-primary">ანაზღაურება</a><span class="float-end"><t t-esc="earning.value.toFixed(2)"/></span></li>
              </ul>
              <div id="chartContainer1" t-ref="chart1" style="height: 250px; width: 100%;"/>
            </div>

            <div class="chart-card">
              <h5 class="fw-bold mb-3">Payroll By Projects</h5>
              <div id="chartContainer2" t-ref="chart2" style="height: 300px; width: 100%;"/>
            </div>

            <div class="chart-card">
              <h5 class="fw-bold mb-3">Payroll By Departments</h5>
              <div id="chartContainer3" t-ref="chart3" style="height: 400px; width: 100%;"/>
            </div>
          </div>

          <div class="chart-card" style="flex-basis: 100%; margin-top: 0rem;">
            <h5 class="fw-bold mb-3">Payroll By Earning Code</h5>
            <div id="renderColumnChart2" t-ref="chart4" style="height: 400px; width: 100%;"/>
          </div>
        </t>

        </div>
      </div>

      <div t-attf-class="col-12 col-lg-5 h-100 m-0 pt-2 pt-md-3 pe-md-3 ps-0 #{state.isCollapsed ? 'collapsed-note' : ''}">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <button class="btn btn-sm btn-outline-secondary" title="Note" t-on-click="toggleCollapse">
            <t t-if="state.isCollapsed">➕</t>
            <t t-else="">➖</t>
          </button>
        </div>

        <t t-if="!state.isCollapsed">
          <div class="note-scroll-wrapper">
            <PayrollDashboardTodo orderBy="[{name: 'id', asc: true}]"/>
          </div>
        </t>
      </div>
    </div>
  </t>
</templates>
